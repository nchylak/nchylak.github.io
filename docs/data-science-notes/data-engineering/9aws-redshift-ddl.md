---
layout: default
title: Redshift DDL
parent: Data engineering
grand_parent: Data science notes
permalink: /docs/data-science-notes/data-engineering/9aws-redshift-ddl/
nav_order: 9
---

# Redshift DDL

## `COPY`

[Documentation](https://docs.aws.amazon.com/redshift/latest/dg/r_CREATE_TABLE_NEW.html)

```sql
CREATE [ [LOCAL ] { TEMPORARY | TEMP } ] TABLE 
[ IF NOT EXISTS ] table_name
( { column_name data_type [column_attributes] [ column_constraints ] 
  | table_constraints
  | LIKE parent_table [ { INCLUDING | EXCLUDING } DEFAULTS ] } 
  [, ... ]  )
[ BACKUP { YES | NO } ]
[table_attribute]

where column_attributes are:
  [ DEFAULT default_expr ]
  [ IDENTITY ( seed, step ) ] 
  [ GENERATED BY DEFAULT AS IDENTITY ( seed, step ) ]             
  [ ENCODE encoding ] 
  [ DISTKEY ]
  [ SORTKEY ]
  [ COLLATE CASE_SENSITIVE | COLLATE CASE_INSENSITIVE  ]

and column_constraints are:
  [ { NOT NULL | NULL } ]
  [ { UNIQUE  |  PRIMARY KEY } ]
  [ REFERENCES reftable [ ( refcolumn ) ] ] 

and table_constraints  are:
  [ UNIQUE ( column_name [, ... ] ) ]
  [ PRIMARY KEY ( column_name [, ... ] )  ]
  [ FOREIGN KEY (column_name [, ... ] ) REFERENCES reftable [ ( refcolumn ) ] 


and table_attributes are:
  [ DISTSTYLE { AUTO | EVEN | KEY | ALL } ] 
  [ DISTKEY ( column_name ) ]
  [ [COMPOUND | INTERLEAVED ] SORTKEY ( column_name [,...]) |  [ SORTKEY AUTO ] ]
  [ ENCODE AUTO ]
```

## Distribution style

There are four distributions types:

* EVEN distribution
* ALL distribution
* AUTO distribution
* KEY distribution

### EVEN distribution

The rows are distributed to all CPUs evenly. The number of rows is not looked at at the beginning so the rows are distributed one after the other to all the CPUs available. E.g. For a table of 1000 rows, and 2 CPUs: The first CPU will not receive rows 1 to 500 but rather rows 1, 3, 5, etc.

This is good if the table is not expected to be joined, otherwise joins would create a lot of inter-CPU/storage traffic (**shuffling**) decreasing the performance.

### ALL distribution

Small tables are replicated on all slices to speed up joins. Bigger tables (usually fact tables) can keep an EVEN distribution and smaller ones (usually dimension tables) can have an ALL distribution.

 **Broadcasting** is a common term used to the implementation of the ALL distribution style.

```
CREATE TABLE table_name (
	mykeyfield integer not null,
	otherfield float,
	....
diststyle all
);
```



### AUTO distribution

This leaves the decision to Redshift. Small tables are implemented with an ALL strategy and large tables with an EVEN strategy.

### KEY distribution

Rows having a similar value are placed in the same slice/CPU.

When dimension tables are too big for an ALL distribution, we can distribute both the fact table and the dimension table using the same distribution key. That way, when joining the two tables, all joins would be intra-CPUs and be fast.

```sql
CREATE TABLE table_name (
	mykeyfield integer not null distkey,
	otherfield float,
	....
);
```

## Sorting key

When a sorting key is defined, rows are sorted BEFORE being distributed to the slices (so it affects also distribution).

It minimises query time if the data that is queried is sorted in a way that the queried rows are next to each other. Sort key should therefore be columns that are used frequently in sorting, like for example the date.

Columns can be both distribution keys and sorting keys.

```sql
CREATE TABLE table_name (
	mykeyfield integer not null distkey sortkey,
	otherfield float,
	....
);
```
